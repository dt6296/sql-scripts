


--DataDictionary


SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

WITH myCTE
AS
(
	SELECT 1 AS Level, parent.HierarchyID, parent.ParentID, parent.TableID
	FROM DDHierarchy AS parent
	WHERE parent.ParentID IS NULL
	
	UNION ALL
	
	SELECT rCTE.Level + 1 AS Level, child.HierarchyID, child.ParentID, child.TableID
	FROM DDHierarchy AS child
	INNER JOIN myCTE AS rCTE ON child.ParentID = rCTE.HierarchyID
	WHERE child.ParentID IS NOT NULL

	AND Level < 4 --@MaxLevels
)

SELECT DISTINCT 
myCTE.*, 
SecurityData.*

FROM myCTE



INNER JOIN

(

SELECT
m.ModuleID, m.MainTableID, t.TableName AS Module, lmn.ModuleLabel,

sg.SecurityGroupID, sg.SecurityGroup,

sghx.Addable, sghx.Deletable, sghx.Editable, sghx.Viewable,

h.HierarchyID AS HID, h.ParentID AS PID, lhn.HierarchyLabel, h.HierarchyRoot, h.ShowInHierView,

t.TableID, t.TableName, t.TableName AS [Table], ltn.TableLabel, t.PKColumnID, t.PKColumnName, t.MainDataColumnID, t.MainDataColName,

c.ColumnID, c.ColumnName, c.PhysTableID, c.SortingColumnID, c.AuthorityTableID, c.IsIdentity, c.Type, c.Varfix, c.Length, c.Nullable, c.AuditTrail, c.Description, lcn.ColumnLabel, lcn.HelpText, cln.LocalNote,

CASE WHEN sghx.Deletable = 1 THEN 3
ELSE CASE WHEN (sghx.Editable = 1 OR sghx.Addable = 1) THEN 2
ELSE CASE WHEN sghx.Viewable = 1 THEN 1 ELSE 0 END END END AS SecuritySummary,
CASE WHEN sghx.Deletable = 1 THEN 'FULL'
ELSE CASE WHEN (sghx.Editable = 1 OR sghx.Addable = 1) THEN 'Add/Edit'
ELSE CASE WHEN sghx.Viewable = 1 THEN 'View Only' ELSE 'None' END END END AS SecuritySummaryDesc


FROM SecurityGroups AS sg
LEFT OUTER JOIN SecGrpHierXref AS sghx ON sg.SecurityGroupID = sghx.SecurityGroupID
LEFT OUTER JOIN DDHierarchy AS h ON sghx.HierarchyID = h.HierarchyID
LEFT OUTER JOIN DDLocalHierNames AS lhn ON h.HierarchyID = lhn.HierarchyID
LEFT OUTER JOIN DDTables AS t ON h.TableID = t.TableID
LEFT OUTER JOIN	DDLocalTableNames AS ltn ON t.TableID = ltn.TableID
LEFT OUTER JOIN DDSecGrpXref AS sgx ON h.HierarchyID = sgx.HierarchyID AND sg.SecurityGroupID = sgx.SecurityGroupID
LEFT OUTER JOIN DDColumns AS c ON sgx.ColumnID = c.ColumnID
LEFT OUTER JOIN DDModules AS m ON t.ModuleType = m.ModuleID
LEFT OUTER JOIN DDLocalModuleNames AS lmn ON m.ModuleID = lmn.ModuleID
LEFT OUTER JOIN DDLocalColumnNames AS lcn ON c.ColumnID = lcn.ColumnID and lcn.LanguageID = 1
LEFT OUTER JOIN MFAHt_Column_LocalNotes AS cln ON c.ColumnID = cln.ColumnID

WHERE 
	(lmn.LanguageID = 1 OR lmn.LanguageID IS NULL)
AND (lhn.LanguageID = 1 OR lhn.LanguageID IS NULL)
AND (ltn.LanguageID = 1 OR ltn.LanguageID IS NULL)


--AND h.TableID = 108
--AND sgx.ColumnID = 1223
--AND h.ShowInHierView = 1


--AND (h.HierarchyRoot LIKE ('a108' + '%') OR h.HierarchyRoot = '' )--@Module

AND sghx.SecurityGroupID IN (43) --40 @SecurityGroup

AND sghx.HierarchyID NOT IN 
(
662,126985,126722,126723,126724,126725,126771,127074,127075,127076,127077,127078,127079,127080,127081,127082,126673,126674,126675,126676,126677,126678,126679,126680,126681,126797,126798,126799,126800,126801,126802,126803,126804,126906,126907,126908,126909,
126710,126711,126712,126823,126824,126825,126860,127053,126760,126905,127064,127065,127066,127067,126657,126658,126659,126660,126661,126662,126663,126664,126958,126959,126960,126961,127054,127055,127056,127057,127058,127059,127060,127061,127062,127063,126986,126987,126988,126989,126990,126991,126766,126767,126768,126769,127084,126665,126666,126667,126668,126669,126670,126791,126792,126793,126794,126795,126796,126815,126816,126817,126818,126819,126820,126811,126812,126813,126814,126644,126645,126646,126647,126648,126649,126829,126830,126831,126832,
126753,126754,126755,126756,126757,126758,126736,126737,126738,126739,126957,127072,127073,126805,126806,126717,126821,126822,126759,127068,126790,126833,126982,126643,126746,126962,
126726,126727,126728,126729,126910,126911,126912,126913,126914,126915,126963,126964,126965,126966,126967,126977,126978,126979,126980,126981,
126650,126651,126652,126747,126748,126749,126750,126751,126752,126836,126837,126838,126839,126840,126841,126842,126843,126844,126845,126846,126847,126848,126849,126850,126851,126852,126853,126953,
126968,126969,126970,126732,126733,126734,126735,126975,126976,126807,126808,126809,126810,126718,126719,126720,126721,126983,127069,127070,127071,126635,126636,126637,126638,123369,123340,126641,126642,126764,126765,126834,126835,126653,126654,126655,126656,126772,126992,126993,126994,126954,126955,126956,126826,126827,126828,126761,126762,
126763,126682,126683,126684,126685,126686,126687,126688,126689,126694,126695,126696,126697,126698,126699,126700,126701,127052,126716,126916,126917,126918,126926,126927,126928,126713,126714,126715,126706,126707,126708,126709,126971,126972,126973,126974,126634,126984,126702,126703,126704,126705,
126639,126640,126919,
126770,126690,126691,126692,126693,126861,126862,126863,126864,126865,126866,126867,126868,126869,126870,126871,126872,126873,126874,126875,126876,126877,126878,126879,126880,126881,126882,126883,126884,126885,126886,126887,126888,126889,126890,126891,126892,126893,126894,126895,126896,126897,126898,126899,126900,126901,126902,126903,126904,127046,127047,127048,127049,127050,127051,126929,126930,126931,126932,126933,126934,126935,126936,126937,126938,126939,126940,126941,126942,126943,126944,126945,126946,126947,126948,126949,126950,126951,126952,126995,126996,126997,126998,126999,127000,127001,127002,127003,127004,127005,127006,127007,127008,127009,127010,127011,127012,127013,127014,127015,127016,127017,127018,127019,127020,127021,127022,127023,127024,127025,127026,127027,127028,127029,127030,127031,127032,127033,127034,127035,127036,127037,127038,127039,127040,127041,127042,127043,127044,127045,
126671,126672,126854,126855,126730,126731,126920,126921,126922,126923,126924,126925,126740,126741,126742,126743,126744,126745,126773,126774,126775,126776,126777,126778,126779,126780,126781,126782,126783,126784,126785,126786,126787,126788,126789,127083,

126856,126857,126858,126859,225901,225902,225903,225904,227097,227098,227099,227100
)
)

AS SecurityData ON SecurityData.HID = myCTE.HierarchyID


ORDER BY Level, TableLabel